-- Tablas maestras
CREATE TABLE IF NOT EXISTS CLIENTES (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  rut TEXT UNIQUE NOT NULL,
  nombre TEXT NOT NULL,
  fecha_nacimiento TEXT,
  telefono TEXT,
  email TEXT
);

CREATE TABLE IF NOT EXISTS FALLECIDOS (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  rut TEXT UNIQUE,
  nombre TEXT NOT NULL,
  fecha_nacimiento TEXT,
  fecha_defuncion TEXT,
  es_vt INTEGER DEFAULT 0
);

CREATE TABLE IF NOT EXISTS FUNERARIAS (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  nombre TEXT UNIQUE NOT NULL,
  es_socia INTEGER DEFAULT 0,
  activa INTEGER DEFAULT 1
);

CREATE TABLE IF NOT EXISTS MESES_COMERCIALES (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  nombre TEXT UNIQUE NOT NULL, -- SEPTIEMBRE-2025
  fecha_inicio TEXT NOT NULL,
  fecha_termino TEXT,
  meta INTEGER DEFAULT 0
);

CREATE TABLE IF NOT EXISTS SERVICIOS_ADICIONALES (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  nombre TEXT UNIQUE NOT NULL,
  comision_fija REAL NOT NULL
);

-- Tabla de ventas
CREATE TABLE IF NOT EXISTS VENTAS (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  fecha TEXT NOT NULL,
  tipo TEXT CHECK(tipo IN ('Sepultura','Cinerario','Servicio Adicional')) NOT NULL,
  unidad_negocio TEXT,
  cliente_id INTEGER NOT NULL,
  fallecido_id INTEGER,
  funeraria_id INTEGER,
  mes_comercial_id INTEGER NOT NULL,
  FOREIGN KEY(cliente_id) REFERENCES CLIENTES(id),
  FOREIGN KEY(fallecido_id) REFERENCES FALLECIDOS(id),
  FOREIGN KEY(funeraria_id) REFERENCES FUNERARIAS(id),
  FOREIGN KEY(mes_comercial_id) REFERENCES MESES_COMERCIALES(id)
);

-- Tablas hijas 1-to-1
CREATE TABLE IF NOT EXISTS VENTA_SEPULTURAS (
  venta_id INTEGER PRIMARY KEY,
  valor_total REAL NOT NULL,
  pago_inicial REAL NOT NULL,
  num_cuotas INTEGER NOT NULL,
  valor_cuota REAL NOT NULL,
  fecha_primera_cuota TEXT NOT NULL,
  medio_pago TEXT,
  FOREIGN KEY(venta_id) REFERENCES VENTAS(id) ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS VENTA_CINERARIOS (
  venta_id INTEGER PRIMARY KEY,
  valor_venta REAL NOT NULL,
  FOREIGN KEY(venta_id) REFERENCES VENTAS(id) ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS VENTA_SERVICIOS (
  venta_id INTEGER NOT NULL,
  servicio_id INTEGER NOT NULL,
  PRIMARY KEY(venta_id, servicio_id),
  FOREIGN KEY(venta_id) REFERENCES VENTAS(id) ON DELETE CASCADE,
  FOREIGN KEY(servicio_id) REFERENCES SERVICIOS_ADICIONALES(id)
);

-- √çndices frecuentes
CREATE INDEX IF NOT EXISTS idx_ventas_mes ON VENTAS(mes_comercial_id);
CREATE INDEX IF NOT EXISTS idx_ventas_tipo ON VENTAS(tipo);